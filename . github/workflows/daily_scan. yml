name: IPO GMP Watcher

on:
  schedule:
    - cron: '*/30 * * * *'  # Runs every 30 minutes
  workflow_dispatch:        # Allow manual trigger

jobs:
  check_ipos:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: Run IPO Watcher Check
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets. TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python3 << 'EOF'
          import json
          import os
          import sys
          from datetime import datetime

          # Import our modules
          from scraper import get_ipos_from_url
          from notifier import send_telegram_notification
          from db import init_db, get_ipo, upsert_ipo

          # Setup
          os.makedirs('data', exist_ok=True)
          init_db('data/ipo_watcher.db')

          # Get credentials from GitHub Secrets
          bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          gmp_threshold = 20

          if not bot_token or not chat_id:
              print("‚ùå ERROR: Telegram credentials not found in GitHub Secrets!")
              sys.exit(1)

          print("üöÄ Starting IPO Check...")
          print(f"‚è∞ Time: {datetime.now().isoformat()}")

          try:
              # Fetch IPOs from ipowatch.in
              ipos = get_ipos_from_url('https://ipowatch.in/ipo-grey-market-premium-latest-ipo-gmp/')
              print(f"üìä Found {len(ipos)} IPOs on the page")

              # Check each IPO
              high_gmp_ipos = []
              for ipo in ipos:
                  if ipo['gmp'] > gmp_threshold:
                      high_gmp_ipos.append(ipo)
                      print(f"  ‚úÖ {ipo['name']}: {ipo['gmp']}% GMP (> {gmp_threshold}%)")

              if high_gmp_ipos:
                  print(f"\nüéØ Found {len(high_gmp_ipos)} IPO(s) with GMP > {gmp_threshold}%")
              else:
                  print(f"\n‚ö†Ô∏è  No IPOs with GMP > {gmp_threshold}% found")

              # Send notifications
              for ipo in high_gmp_ipos:
                  current = get_ipo('data/ipo_watcher.db', ipo['id'])
                  should_notify = not current or (current and current['last_notified'] is None)

                  if should_notify:
                      # Build message
                      msg = f"*üöÄ IPO ALERT - GMP > {gmp_threshold}%*\n\n"
                      msg += f"*Company:* {ipo. get('name', 'N/A')}\n"
                      msg += f"*GMP:* {ipo. get('gmp', 'N/A')}% üìà\n"
                      
                      if ipo.get('subscription'):
                          msg += f"*Current Subscription:* {ipo. get('subscription')}\n"
                      if ipo.get('issue_size'):
                          msg += f"*Total IPO Amount:* {ipo. get('issue_size')}\n"
                      if ipo.get('price_band'):
                          msg += f"*Price Band:* {ipo.get('price_band')}\n"
                      if ipo.get('lot_size'):
                          msg += f"*Lot Size:* {ipo.get('lot_size')}\n"
                      if ipo.get('listing_date'):
                          msg += f"*Listing Date:* {ipo.get('listing_date')}\n"
                      
                      msg += f"\n[üì∞ More Details]({ipo. get('link', 'https://ipowatch.in')})"

                      # Send notification
                      try:
                          send_telegram_notification(msg, bot_token, chat_id)
                          print(f"  ‚úÖ Telegram notification sent for {ipo['name']}")
                          
                          # Mark as notified in DB
                          upsert_ipo('data/ipo_watcher. db', ipo['id'], ipo['name'], ipo['link'], ipo['gmp'], notified=True)
                      except Exception as e:
                          print(f"  ‚ùå Failed to send notification: {e}")
                  else:
                      print(f"  ‚ÑπÔ∏è  Already notified for {ipo['name']}")

              print("\n‚úÖ IPO Check completed successfully!")

          except Exception as e:
              print(f"‚ùå ERROR: {str(e)}")
              import traceback
              traceback.print_exc()
              
              # Send error notification
              error_msg = f"‚ùå *IPO Watcher Error*\n\n{str(e)}"
              try:
                  send_telegram_notification(error_msg, bot_token, chat_id)
              except:
                  pass
              sys.exit(1)

          EOF
